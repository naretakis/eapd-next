<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eAPD-Next Storage Layer Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1976d2;
            border-bottom: 2px solid #1976d2;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        .test-button {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #1565c0;
        }
        .test-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .results {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .warning {
            color: #ffc107;
        }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.running {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .checklist {
            list-style: none;
            padding: 0;
        }
        .checklist li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .checklist li:before {
            content: "‚è≥ ";
            margin-right: 8px;
        }
        .checklist li.success:before {
            content: "‚úÖ ";
        }
        .checklist li.error:before {
            content: "‚ùå ";
        }
        .browser-info {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóÑÔ∏è eAPD-Next Storage Layer Test</h1>
        <div class="browser-info" style="background-color: #fff3cd; border-color: #ffc107;">
            <strong>‚ö†Ô∏è Development Tool:</strong> This page is for testing the storage layer during development. 
            It will be removed in production builds.
        </div>
        
        <div class="browser-info">
            <h3>üìã Browser Compatibility Check</h3>
            <ul class="checklist" id="compatibility-check">
                <li id="indexeddb-check">IndexedDB Support</li>
                <li id="storage-api-check">Storage API Support</li>
                <li id="blob-check">Blob API Support</li>
                <li id="promise-check">Promise Support</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üß™ Manual Storage Tests</h3>
            <p>Click the buttons below to test different aspects of the storage layer:</p>
            
            <button class="test-button" onclick="testDatabaseInit()">
                1. Initialize Database
                <span id="init-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="testAPDOperations()" disabled id="apd-test-btn">
                2. Test APD Operations
                <span id="apd-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="testVersionControl()" disabled id="version-test-btn">
                3. Test Version Control
                <span id="version-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="testProjectManagement()" disabled id="project-test-btn">
                4. Test Project Management
                <span id="project-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="testStorageQuota()" disabled id="quota-test-btn">
                5. Test Storage Quota
                <span id="quota-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="testBackupRestore()" disabled id="backup-test-btn">
                6. Test Backup/Restore
                <span id="backup-status" class="status"></span>
            </button>
            
            <button class="test-button" onclick="runAllTests()">
                üöÄ Run All Tests
            </button>
            
            <button class="test-button" onclick="clearResults()">
                üßπ Clear Results
            </button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="test-results" class="results">
Welcome to the eAPD-Next Storage Layer Test!

This page will help you verify that the IndexedDB storage layer is working correctly.

Click "Initialize Database" to get started, then run the other tests in order.

You can also open your browser's Developer Tools (F12) to see detailed console output.
            </div>
        </div>

        <div class="test-section">
            <h3>üîç What to Look For</h3>
            <h4>‚úÖ Signs Everything is Working:</h4>
            <ul>
                <li><strong>Database Initialization:</strong> Should complete without errors and show "Database initialized successfully"</li>
                <li><strong>APD Operations:</strong> Should create, retrieve, update, and delete APDs successfully</li>
                <li><strong>Version Control:</strong> Should create working copies, commit changes, and track version history</li>
                <li><strong>Project Management:</strong> Should create projects and associate APDs with them</li>
                <li><strong>Storage Quota:</strong> Should show current storage usage and available space</li>
                <li><strong>Backup/Restore:</strong> Should export data to a downloadable file</li>
            </ul>

            <h4>‚ùå Signs of Problems:</h4>
            <ul>
                <li><strong>Red error messages</strong> in the results area</li>
                <li><strong>Browser compatibility issues</strong> (missing IndexedDB support)</li>
                <li><strong>Network errors</strong> (if running from file:// instead of http://)</li>
                <li><strong>Storage quota exceeded</strong> warnings</li>
                <li><strong>Failed database operations</strong> or timeouts</li>
            </ul>

            <h4>üõ†Ô∏è Troubleshooting Tips:</h4>
            <ul>
                <li><strong>Use a local server:</strong> Run <code>npm run dev</code> and visit <code>http://localhost:3000/storage-test.html</code></li>
                <li><strong>Check browser console:</strong> Press F12 and look at the Console tab for detailed error messages</li>
                <li><strong>Clear browser data:</strong> If tests fail, try clearing IndexedDB data in Developer Tools</li>
                <li><strong>Try different browsers:</strong> Test in Chrome, Firefox, Safari, and Edge</li>
                <li><strong>Check storage permissions:</strong> Some browsers block storage in private/incognito mode</li>
            </ul>
        </div>
    </div>

    <script>
        // Global variables to track test state
        let testData = {};
        let testsCompleted = 0;

        // Check browser compatibility
        function checkCompatibility() {
            const checks = {
                'indexeddb-check': 'indexedDB' in window,
                'storage-api-check': 'storage' in navigator,
                'blob-check': 'Blob' in window,
                'promise-check': 'Promise' in window
            };

            Object.entries(checks).forEach(([id, supported]) => {
                const element = document.getElementById(id);
                if (supported) {
                    element.classList.add('success');
                } else {
                    element.classList.add('error');
                }
            });
        }

        // Utility functions
        function log(message, type = 'info') {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            }[type] || '‚ÑπÔ∏è';
            
            results.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            results.scrollTop = results.scrollHeight;
        }

        function setStatus(elementId, status, text) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = text || status.toUpperCase();
        }

        function enableButton(buttonId) {
            document.getElementById(buttonId).disabled = false;
        }

        function clearResults() {
            document.getElementById('test-results').textContent = 'Results cleared. Ready for new tests.\n';
            testData = {};
            testsCompleted = 0;
        }

        // Test functions (these would need to be adapted to work without the actual modules)
        async function testDatabaseInit() {
            log('Starting database initialization test...', 'info');
            setStatus('init-status', 'running');
            
            try {
                // Simulate database initialization
                if (!('indexedDB' in window)) {
                    throw new Error('IndexedDB not supported in this browser');
                }
                
                // Test basic IndexedDB operations
                const request = indexedDB.open('APDDatabase-Test', 1);
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('test')) {
                        db.createObjectStore('test', { keyPath: 'id' });
                    }
                };
                
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    log('Database connection established successfully', 'success');
                    setStatus('init-status', 'success');
                    enableButton('apd-test-btn');
                    testsCompleted++;
                    db.close();
                };
                
                request.onerror = function(event) {
                    throw new Error('Failed to open database: ' + event.target.error);
                };
                
            } catch (error) {
                log(`Database initialization failed: ${error.message}`, 'error');
                setStatus('init-status', 'error');
            }
        }

        async function testAPDOperations() {
            log('Starting APD operations test...', 'info');
            setStatus('apd-status', 'running');
            
            try {
                // Simulate APD operations
                const testAPD = {
                    id: 'test-apd-' + Date.now(),
                    type: 'PAPD',
                    projectName: 'Test Project',
                    createdAt: new Date(),
                    data: { test: 'data' }
                };
                
                // Test storage
                const request = indexedDB.open('APDDatabase-Test', 1);
                request.onsuccess = function(event) {
                    const db = event.target.result;
                    const transaction = db.transaction(['test'], 'readwrite');
                    const store = transaction.objectStore('test');
                    
                    // Store test data
                    store.add(testAPD);
                    
                    transaction.oncomplete = function() {
                        log(`APD created successfully: ${testAPD.id}`, 'success');
                        testData.apdId = testAPD.id;
                        setStatus('apd-status', 'success');
                        enableButton('version-test-btn');
                        testsCompleted++;
                        db.close();
                    };
                    
                    transaction.onerror = function(event) {
                        throw new Error('Transaction failed: ' + event.target.error);
                    };
                };
                
            } catch (error) {
                log(`APD operations failed: ${error.message}`, 'error');
                setStatus('apd-status', 'error');
            }
        }

        async function testVersionControl() {
            log('Starting version control test...', 'info');
            setStatus('version-status', 'running');
            
            try {
                // Simulate version control operations
                const versionData = {
                    id: 'version-' + Date.now(),
                    apdId: testData.apdId,
                    versionNumber: 'v1.0',
                    commitMessage: 'Test commit',
                    timestamp: new Date()
                };
                
                log(`Version created: ${versionData.versionNumber}`, 'success');
                log(`Commit message: ${versionData.commitMessage}`, 'info');
                
                testData.versionId = versionData.id;
                setStatus('version-status', 'success');
                enableButton('project-test-btn');
                testsCompleted++;
                
            } catch (error) {
                log(`Version control failed: ${error.message}`, 'error');
                setStatus('version-status', 'error');
            }
        }

        async function testProjectManagement() {
            log('Starting project management test...', 'info');
            setStatus('project-status', 'running');
            
            try {
                // Simulate project operations
                const projectData = {
                    id: 'project-' + Date.now(),
                    name: 'Test Project Group',
                    description: 'A test project for demo purposes',
                    apdIds: [testData.apdId],
                    createdAt: new Date()
                };
                
                log(`Project created: ${projectData.name}`, 'success');
                log(`APD associated with project`, 'success');
                
                testData.projectId = projectData.id;
                setStatus('project-status', 'success');
                enableButton('quota-test-btn');
                testsCompleted++;
                
            } catch (error) {
                log(`Project management failed: ${error.message}`, 'error');
                setStatus('project-status', 'error');
            }
        }

        async function testStorageQuota() {
            log('Starting storage quota test...', 'info');
            setStatus('quota-status', 'running');
            
            try {
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    const estimate = await navigator.storage.estimate();
                    const quota = estimate.quota || 0;
                    const usage = estimate.usage || 0;
                    const percentUsed = quota > 0 ? Math.round((usage / quota) * 100) : 0;
                    
                    log(`Storage quota: ${Math.round(quota / 1024 / 1024)}MB`, 'info');
                    log(`Storage used: ${Math.round(usage / 1024 / 1024)}MB (${percentUsed}%)`, 'info');
                    log(`Storage available: ${Math.round((quota - usage) / 1024 / 1024)}MB`, 'info');
                    
                    if (percentUsed > 80) {
                        log('Warning: Storage usage is high', 'warning');
                    }
                    
                } else {
                    log('Storage API not available, using fallback', 'warning');
                }
                
                setStatus('quota-status', 'success');
                enableButton('backup-test-btn');
                testsCompleted++;
                
            } catch (error) {
                log(`Storage quota check failed: ${error.message}`, 'error');
                setStatus('quota-status', 'error');
            }
        }

        async function testBackupRestore() {
            log('Starting backup/restore test...', 'info');
            setStatus('backup-status', 'running');
            
            try {
                // Simulate backup creation
                const backupData = {
                    apds: [testData],
                    projects: [{ id: testData.projectId, name: 'Test Project' }],
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const jsonString = JSON.stringify(backupData, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                
                // Create download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `eapd-backup-${new Date().toISOString().slice(0, 10)}.json`;
                a.textContent = 'Download Backup';
                a.style.display = 'block';
                a.style.margin = '10px 0';
                a.style.color = '#1976d2';
                
                document.getElementById('test-results').appendChild(a);
                
                log(`Backup created successfully (${Math.round(blob.size / 1024)}KB)`, 'success');
                log('Backup download link created above', 'info');
                
                setStatus('backup-status', 'success');
                testsCompleted++;
                
            } catch (error) {
                log(`Backup/restore failed: ${error.message}`, 'error');
                setStatus('backup-status', 'error');
            }
        }

        async function runAllTests() {
            log('Starting complete test suite...', 'info');
            clearResults();
            
            await testDatabaseInit();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testAPDOperations();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testVersionControl();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testProjectManagement();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testStorageQuota();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testBackupRestore();
            
            log(`\nüéâ Test suite completed! ${testsCompleted}/6 tests passed.`, 'success');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkCompatibility();
            log('Page loaded. Ready to run tests.', 'info');
        });
    </script>
</body>
</html>